\begin{figure}
\centering

\begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=5cm,
  thick,main node/.style={fill=white!20,draw,font=\sffamily\footnotesize\bfseries}]

  
  \node[main node] (latesRef) [ text width=2.0cm, minimum height=1.5cm, align=center]   {Reference\\(Latest)};
  \node[main node] (ctrl)     [left=0.8cm of latesRef,minimum height=2.5cm, align=center]                           {Controller};
  \node[main node] (getRef)   [right=1.5cm of latesRef, text width=3.0cm, minimum height=1.1cm, align=center]      {Get Reference};
 

 % \node[main node] (fromsim)     [above=1.0cm of getRef, text width=3.0cm, minimum height=1.1cm, align=center]    {From Simulator\\ Hold (sim mode)};
 % \node[main node] (sim)         [above=1.0cm of fromsim, text width=3.0cm, minimum height=1.1cm, align=center]    {Simulator \\Trigger\\ (sim mode)};

 \node[main node, draw=white] (haname2)   [above=0.2cm of getRef, align=center]   {};

  \node[main node] (dodebug)     [below=1.0cm of getRef, text width=3.0cm, minimum height=1.1cm, align=center]    {User Commands\\ (debug)};
  \node[main node] (tosim)       [below=1.0cm of dodebug, text width=3.0cm, minimum height=1.1cm, align=center]    {To Simulator\\ Trigger};
  \node[main node] (filter)      [below=1.0cm of tosim, text width=3.0cm, minimum height=1.1cm, align=center]     {Filter};
  \node[main node] (setRef)      [below=1.0cm of filter, text width=3.0cm, minimum height=1.1cm, align=center]    {Set Reference};
  \node[main node] (reqSens)     [below=1.0cm of setRef, text width=3.0cm, minimum height=1.1cm, align=center]    {Request Sensors};
  \node[main node] (getSens)     [below=1.0cm of reqSens, text width=3.0cm, minimum height=1.1cm, align=center]   {Get Sensors};
  \node[main node] (canWait)     [below=1.0cm of getSens, text width=3.0cm, minimum height=1.1cm, align=center]   {Wait on CAN};
  \node[main node] (putState)    [below=1.0cm of canWait, text width=3.0cm, minimum height=1.1cm, align=center]   {Put State};
  \node[main node] (rthold)      [left=0.5cm of getSens, minimum height=1.1cm, align=center]   {Real-Time\\Hold};



  \node[main node] (latestState) [left=1.5cm of putState, text width=2.0cm, minimum height=1.1cm, align=center, yshift=-1.0cm]   {State\\(Latest)};
  \node[main node, draw=white] (haname)   [right=3.0cm of putState, align=center]   {};

  \node[main node] (robot)    [right=4.8cm of getSens, minimum height=5.5cm, align=center]    {Robot};
  

%H_ref.ref[jnt] = deg;
%H_ref.mode[jnt] = HUBO_REF_MODE_ENC_FILTER;

  \path[->, dashed,every node/.style={font=\sffamily\small}]
    (ctrl) edge node [above] {} (latesRef);

%  \path[->, every node/.style={font=\sffamily\small}]
%    (fromsim) edge node [right] {$t_0=0.011~ms$} (getRef);
%\draw[->] ([xshift=-1.2 cm]fromsim.south)  to [out=-90,in=90] node [right] {$t_0=0.011~ms$} ([xshift=-1.2 cm]getRef.north)  ;
%\draw[->] ([xshift=-1.2 cm]getRef.south)   to [out=-90,in=90] node [right] {$t_1=0.011~ms$} ([xshift=-1.2 cm]tosim.north)  ;
%\draw[->] ([xshift=-1.2 cm]tosim.south)   to [out=-90,in=90] node [right] {$t_2=0.011~ms$} ([xshift=-1.2 cm]filter.north)  ;
%\draw[->] ([xshift=-1.2 cm]filter.south)   to [out=-90,in=90] node [right] {$t_3=???~ms$} ([xshift=-1.2 cm]setRef.north)  ;
%\draw[->] ([xshift=-1.2 cm]setRef.south)   to [out=-90,in=90] node [right] {$t_4=???~ms$} ([xshift=-1.2 cm]reqSens.north)  ;
%\draw[->] ([xshift=-1.2 cm]reqSens.south)   to [out=-90,in=90] node [right] {$t_5=???~ms$} ([xshift=-1.2 cm]getSens.north)  ;
%\draw[->] ([xshift=-1.2 cm]getSens.south)   to [out=-90,in=90] node [right] {$t_6=0.011~ms$} ([xshift=-1.2 cm]putState.north)  ;
%\draw[->] ([xshift=0.0 cm]putState.west)   to [out=180,in=-90] node [below, yshift=-0.5cm, xshift=-0.2cm] {$t_7=0.011~ms$} ([xshift=0.0 cm]rthold.south)  ;


\draw[->] ([xshift=0.0cm]latesRef.east)  to [out=0,in=-180]  node [right]  {} ([xshift=0.0cm]getRef.west)  ;
%\draw[->] ([xshift=0.0cm]fromsim.south)  to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]getRef.north)  ;
\draw[->] ([xshift=0.0cm]getRef.south)   to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]dodebug.north)  ;
\draw[->] ([xshift=0.0cm]dodebug.south)  to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]tosim.north)  ;
\draw[->] ([xshift=0.0cm]tosim.south)    to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]filter.north)  ;
\draw[->] ([xshift=0.0cm]filter.south)   to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]setRef.north)  ;
\draw[->] ([xshift=0.0cm]setRef.south)   to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]reqSens.north)  ;
\draw[->] ([xshift=0.0cm]reqSens.south)  to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]getSens.north)  ;
\draw[->] ([xshift=0.0cm]getSens.south)  to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]canWait.north)  ;
\draw[->] ([xshift=0.0cm]canWait.south)  to [out=-90,in=90]  node [right]  {} ([xshift=0.0cm]putState.north)  ;
\draw[->] ([xshift=0.0 cm]putState.west) to [out=180,in=-90] node [below, yshift=-0.5cm, xshift=-0.2cm] {} ([xshift=0.0 cm]rthold.south)  ;
\draw[->] ([xshift=0.0 cm]rthold.north)  to [out=90,in=-120] node [left, yshift=-1.0cm, xshift=-0.8cm, rotate=90] {} ([xshift=0.0 cm]getRef.west)  ;
\draw[->] ([xshift=0.0cm]putState.south) to [out=-90,in=0]   node [right]  {} ([xshift=0.0cm]latestState.east)  ;




%\draw[->] ([yshift=0.75cm]fromsim.east)  to [out=-30,in=30] node [right] {$t_0=0.014~ms$} ([yshift=-0.75cm]fromsim.east)  ;
\draw[->] ([yshift=0.75cm]getRef.east)  to [out=-30,in=30] node [right] {$t_0=0.010~ms$} ([yshift=-0.75cm]getRef.east)  ;
\draw[->] ([yshift=0.75cm]dodebug.east)  to [out=-30,in=30] node [right] {$t_1=0.011~ms$} ([yshift=-0.75cm]dodebug.east)  ;
\draw[->] ([yshift=0.75cm]tosim.east)  to [out=-30,in=30] node [right] {$t_2=0.014~ms$} ([yshift=-0.75cm]tosim.east)  ;
\draw[->] ([yshift=0.75cm]filter.east)  to [out=-30,in=30] node [right] {$t_3=0.008~ms$} ([yshift=-0.75cm]filter.east)  ;
\draw[->] ([yshift=0.75cm]setRef.east)  to [out=-30,in=30] node [right] {$t_4=0.152~ms$} ([yshift=-0.75cm]setRef.east)  ;
\draw[->] ([yshift=0.75cm]reqSens.east)  to [out=-47,in=47] node [right] {$t_5=1.365~ms$} ([yshift=-0.75cm]getSens.east)  ;
\draw[->] ([yshift=0.75cm]canWait.east)  to [out=-30,in=30] node [right,align=center] {$t_6=3.000~ms$\\(hard timeout)} ([yshift=-0.75cm]canWait.east)  ;
%\draw[->] ([yshift=0.75cm]reqSens.east)  to [out=-30,in=30] node [right] {$t_5=???~ms$} ([yshift=-0.75cm]reqSens.east)  ;
%\draw[->] ([yshift=0.75cm]getSens.east)  to [out=-30,in=30] node [right] {$t_6=???~ms$} ([yshift=-0.75cm]getSens.east)  ;
\draw[->] ([yshift=0.75cm]putState.east)  to [out=-30,in=30] node [right] {$t_7=0.092~ms$} ([yshift=-0.75cm]putState.east)  ;
\draw[->] ([yshift=-0.75cm]rthold.west)  to [out=120,in=-120] node [above, yshift=1.5cm, xshift=0.3cm, rotate=90] {$\displaystyle t_{hold}=T-\sum_{i=0}^{8} t_i=0.348~ms$} ([yshift=0.75cm]rthold.west)  ;

\draw[->, dashed] ([xshift=0.0cm]latestState.west)   to [out=120,in=-90] node [right] {} ([xshift=0.0cm]ctrl.south)  ;
%\draw[->, dashed] ([xshift=0.0cm]sim.south)   to [out=-90,in=90] node [right] {} ([xshift=0.0cm]fromsim.north)  ;

\node[fit=(getRef)(putState)(rthold)(haname)(latestState)(haname2), draw,label={south:Hubo-Ach}] (hubo-ach) [minimum width=4.5cm] {};




\draw[->,loosely dotted] ([xshift=0.75cm]reqSens.south)  to [out=-30,in=-180] node [above] {} ([yshift=0.75cm]robot.west)  ;
\draw[<-,loosely dotted] ([xshift=0.0cm]getSens.east)  to [out=0,in=-180] node [above, xshift=1.7cm] {CAN} ([yshift=0.0cm]robot.west)  ;
\draw[<-,loosely dotted] ([xshift=0.75cm]canWait.north)  to [out=30,in=-180] node [above] {} ([yshift=-0.75cm]robot.west)  ;




%  \path[->,every node/.style={font=\sffamily\small}]
%    (ik) edge node [above] {$\overline{\theta_d}$} (filter);

% \draw[->] ([xshift=-0.5 cm]filter.south)  -- node [left] {$\overline{\theta_r}$} ([xshift=-0.5 cm]hubo-ach.north)  ;
% \draw[->] ([xshift=0.5 cm]hubo-ach.north) -- node [left] {$\overline{\theta_a}$} ([xshift=0.5 cm]filter.south)  ;

% \path[<->,dashed, every node/.style={font=\sffamily\small}]
%    (hubo) edge node [above] {CAN} (hubo-ach);


\end{tikzpicture}
\caption{Timing diagram of Hubo-Ach.  All times $t_*$ denote measured times each block takes to complete.  Tests were done on a 1.6Ghz Atom D525 Dual Core with 1GB DDR3 800Mhz memory running Ubuntu 12.04 LTS linux kernel 3.2.0-29 on a Hubo2+ utilizing a CAN bus running at 1Mbps baud.  Average CPU usage is 7.6\% using a total of 4Mb or memory.}
\label{fig:hubo-ach-timing}
\end{figure}

